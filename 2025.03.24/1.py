import pandas as pd
import numpy as np
from pathlib import Path

# Пути к данным
base_path = Path(".")
file_science = base_path / "science_investetions.csv"
file_cancer = base_path / "early_malignancy.csv"

# Загрузка и обработка данных
def load_and_clean(path, skip):
    data = pd.read_csv(path, skiprows=skip, header=None)
    data = data.iloc[:, 0].str.split(expand=True)
    data.columns = ['Year', 'Value']
    data['Year'] = data['Year'].astype(int)
    data['Value'] = data['Value'].astype(float)
    return data

science = load_and_clean(file_science, 20)
cancer = load_and_clean(file_cancer, 19)

# Объединение по годам
joined = pd.merge(science, cancer, on="Year", how="inner", suffixes=('_science', '_cancer')).sort_values("Year")

# Нормализация значений
def normalize(series):
    return (series - series.min()) / (series.max() - series.min())

joined['science_norm'] = normalize(joined['Value_science'])
joined['cancer_norm'] = normalize(joined['Value_cancer'])

# Проверка корреляций со сдвигом
def test_lags(df, col1, col2, max_lag=5):
    results = []
    for lag in range(-max_lag, max_lag + 1):
        temp = df.copy()
        if lag > 0:
            temp[col1] = temp[col1].shift(lag)
        elif lag < 0:
            temp[col2] = temp[col2].shift(-lag)
        temp = temp.dropna()
        if len(temp) > 2:
            r = np.corrcoef(temp[col1], temp[col2])[0, 1]
            print(f"Сдвиг: {lag} лет")
            print(f"{col1}: {temp[col1].tolist()}")
            print(f"{col2}: {temp[col2].tolist()}")
            print(f"Корреляция: {round(r, 4)}\n")
            results.append((lag, r))
    return results

# Запуск анализа
correlations = test_lags(joined, 'science_norm', 'cancer_norm', max_lag=5)

# Лучшая корреляция
if correlations:
    top_lag, top_corr = max(correlations, key=lambda x: abs(x[1]))
    print(f"Макс. корреляция: {round(top_corr, 4)} при сдвиге {top_lag} лет")
    
#C:\Git\Sajgakova\2025.03.24>python -i 1.py
#Сдвиг: -5 лет
#science_norm: [0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966, 1.0]
#cancer_norm: [0.0, 0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549]
#Корреляция: 0.9659
#
#Сдвиг: -4 лет
#science_norm: [0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966, 1.0]
#cancer_norm: [0.0, 0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455]
#Корреляция: 0.9606
#
#Сдвиг: -3 лет
#science_norm: [0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966, 1.0]
#cancer_norm: [0.0, 0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092]
#Корреляция: 0.9597
#
#Сдвиг: -2 лет
#science_norm: [0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966, 1.0]
#cancer_norm: [0.0, 0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909]
#Корреляция: 0.8923
#
#Сдвиг: -1 лет
#science_norm: [0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966, 1.0]
#cancer_norm: [0.0, 0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091]
#Корреляция: 0.9197
#
#Сдвиг: 0 лет
#science_norm: [0.0, 0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966, 1.0]
#cancer_norm: [0.0, 0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091, 1.0]
#Корреляция: 0.9638
#
#Сдвиг: 1 лет
#science_norm: [0.0, 0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342, 0.806764064615966]
#cancer_norm: [0.034090909090908776, 0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091, 1.0]
#Корреляция: 0.9604
#
#Сдвиг: 2 лет
#science_norm: [0.0, 0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727, 0.6535884724603342]
#cancer_norm: [0.1704545454545455, 0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091, 1.0]
#Корреляция: 0.9713
#
#Сдвиг: 3 лет
#science_norm: [0.0, 0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585, 0.6074866133064727]
#cancer_norm: [0.3636363636363641, 0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091, 1.0]
#Корреляция: 0.943
#
#Сдвиг: 4 лет
#science_norm: [0.0, 0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765, 0.4578677145984585]
#cancer_norm: [0.47727272727272774, 0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091, 1.0]
#Корреляция: 0.9165
#
#Сдвиг: 5 лет
#science_norm: [0.0, 0.0672464263185927, 0.2102556563427966, 0.2984653966330257, 0.3276647952706076, 0.4422387732348765]
#cancer_norm: [0.5795454545454549, 0.6704545454545455, 0.7840909090909092, 0.659090909090909, 0.840909090909091, 1.0]
#Корреляция: 0.8484
#
#Макс. корреляция: 0.9713 при сдвиге 2 лет